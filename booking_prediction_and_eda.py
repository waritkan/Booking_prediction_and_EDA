# -*- coding: utf-8 -*-
"""Booking_prediction_and_EDA.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1phoHvWzEpoBao53jzbggNkCqInTVauyz
"""

!pip install opendatasets

import opendatasets as od
import pandas as pd
import os
import numpy as np
import folium
import plotly.express as px
import matplotlib
import matplotlib.pyplot as plt
from datetime import datetime
from plotly.subplots import make_subplots
import plotly.graph_objects as go

dataset = "https://www.kaggle.com/datasets/jessemostipak/hotel-booking-demand"
od.download(dataset)

data_dir = '/content/hotel-booking-demand'

df = pd.read_csv(os.path.join(data_dir, 'hotel_bookings.csv'))
df.head(5)

df.info()

df.describe()

df[['market_segment', 'distribution_channel']].head(5)

market_segment_counts = df['market_segment'].value_counts()
distribution_channel_counts = df['distribution_channel'].value_counts()
combined_counts_df = pd.DataFrame({'market_segment_counts': market_segment_counts, 'distribution_channel_counts': distribution_channel_counts})

print(combined_counts_df)

"""'market_segment' and 'distribution_channel' are related, we would like to drop the 'distribution_channel' column because it has less detail."""

df.drop(['distribution_channel'],axis=1,errors='ignore')

""" Next, we will deal with missing data."""

non_null_counts = df.count()
columns_with_less_data = non_null_counts[non_null_counts != df.shape[0]]

print(columns_with_less_data)

df = df.dropna(subset=['children', 'country'])
df = df.fillna(0)

nan_in_df = df.isnull().sum().sum()
print('Number of NaN values present: ' + str(nan_in_df))

df_backup = df.copy()
df.head(10)

"""# 1.EDA

## What country do most guests come from?
"""

df_guests = df.groupby('arrival_date_year')['country'].value_counts().reset_index()
df_guests.head(5)

fig = px.choropleth(df_guests, locations='country', color='count', hover_name='country',
                    projection='natural earth', animation_frame='arrival_date_year',
                    title='Number of guests by year')
fig.show()

"""Most of the guests come from Europe. Most of them are Portuguese.

## What is the average number of guests staying each month?
"""

df_guest_month = df
df_guest_month= pd.DataFrame(df.groupby(['arrival_date_month']).size().reset_index(name='guest_count'))
df_guest_month['Not Canceled'] = df[df['is_canceled'] == 0].groupby(['arrival_date_month']).size().values
df_guest_month['Canceled'] = df[df['is_canceled'] == 1].groupby(['arrival_date_month']).size().values
df_guest_month.set_index('arrival_date_month', inplace=True)



def divide_value(row):
    if row.name in ['August','July']:
        return row // 3
    else:
        return row // 2

numeric_columns = df_guest_month.select_dtypes(include=['number']).columns
df_guest_month[numeric_columns] = df_guest_month[numeric_columns].apply(divide_value, axis=1)
df_guest_month

"""Find the average number of guests staying each month. Each month has a different amount of data. Therefore, we must create a function to find the average."""

plt.figure(figsize = (12, 4))

px.bar(df_guest_month, x = df_guest_month.index, y = ['Not Canceled','Canceled'],
        title = 'Number of guests each month classified by Canceled and Not_Canceled.')

"""The ratio of Canceled to Not_Canceled was similar every month.

## Compare the number of Canceled and Not Canceled.
"""

month_to_number = {'January': 1, 'February': 2, 'March': 3, 'April': 4, 'May': 5, 'June': 6,
                  'July': 7, 'August': 8, 'September': 9, 'October': 10, 'November': 11, 'December': 12}
df['arrival_date_month'] = df['arrival_date_month'].map(month_to_number)

df_timeseries = pd.DataFrame(df.groupby(['arrival_date_year', 'arrival_date_month', 'arrival_date_day_of_month']).size().reset_index(name='guest_count'))
df_timeseries['Not Canceled'] = df[df['is_canceled'] == 0].groupby(['arrival_date_year', 'arrival_date_month', 'arrival_date_day_of_month']).size().values
df_timeseries['Canceled'] = df[df['is_canceled'] == 1].groupby(['arrival_date_year', 'arrival_date_month', 'arrival_date_day_of_month']).size().values
df_timeseries['date'] = pd.to_datetime(df_timeseries['arrival_date_year'].astype(str) + '-' + df_timeseries['arrival_date_month'].astype(str) + '-' + df_timeseries['arrival_date_day_of_month'].astype(str), format='%Y-%m-%d')
df_timeseries.drop(['arrival_date_year', 'arrival_date_month', 'arrival_date_day_of_month'], axis=1, inplace=True)
df_timeseries.set_index('date', inplace=True)
df_timeseries.head()

plt.figure(figsize = (12, 4))

px.line(df_timeseries, x = df_timeseries.index, y = ['guest_count'],
        title = 'Number of guest coming to stay in the hotel each day')

plt.figure(figsize = (12,4))

px.line(df_timeseries, x = df_timeseries.index, y = ['Not Canceled','Canceled'],
        title = "Number of guests who canceled vs. guests who didn't cancel")

"""## How does the 'marget_segment' category affect cancellations?"""

df_marget = pd.DataFrame(df.groupby(['market_segment']).size().reset_index(name='guest_count'))
df_marget['Canceled'] = df[df['is_canceled'] == 1].groupby(['market_segment']).size().values
df_marget['Canceled_ratio'] = ((df_marget['Canceled'] / df_marget['guest_count']) * 100).round(2)
df_marget

plt.figure(figsize = (12, 4))
fig = go.Figure(data=[go.Pie(labels=df_marget['market_segment'], values=df_marget['Canceled_ratio'], hole=.3)])
fig.update_layout(title='Canceled Ratio by Market Segment')
fig.show()

"""*   The most popular booking channels are Online TA, Offline TA/TO, Groups and Direct respectively.
*  But it is clear that the channels with the most canceled bookings are Group, Online TA, and Offline TA/TO respectively, which is different from Direct, which has about the same number of bookings but has a lower cancellation ratio.

## Does the number of days prior to the stay affect cancellation?
"""

plt.figure(figsize = (12, 4))
fig = px.violin(df, y='lead_time',  color="is_canceled", box=True, hover_data='market_segment')
fig.show()

"""

*   From the figure, it is indicated that most of the guests who do not cancel their reservations. There will be a lower number of booking days before the arrival date than guests who cancel their reservations. The median stay for guests who didn't cancel was 46 days, and for guests who canceled it was 113 days.
*   It can be concluded that the longer the number of days before the stay, the higher the chance of canceling the reservation.

"""